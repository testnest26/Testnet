<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TESTNEST ‚Äì Learn ‚Ä¢ Practice ‚Ä¢ Test</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#f0f4ff;--white:#ffffff;--text:#1a1f36;--muted:#6b7280;
      --brand:#4f46e5;--brand2:#7c3aed;--accent:#f59e0b;--accent2:#10b981;
      --red:#ef4444;--pink:#ec4899;--sky:#0ea5e9;
      --shadow:0 4px 24px rgba(79,70,229,0.10);
      --radius:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

    /* TOPBAR */
    .topbar{background:var(--white);box-shadow:0 2px 12px rgba(79,70,229,0.08);position:sticky;top:0;z-index:100;}
    .topbar-inner{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .logo-wrap{display:flex;align-items:center;gap:10px;text-decoration:none;}
    .logo-icon{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#4f46e5,#7c3aed);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(79,70,229,0.35);}
    .logo-text{font-family:'Baloo 2',cursive;font-size:22px;font-weight:800;background:linear-gradient(135deg,#4f46e5,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .logo-tag{font-size:10px;background:#eef2ff;color:#4f46e5;border-radius:6px;padding:2px 7px;font-weight:700;}
    .user-pill{display:flex;align-items:center;gap:8px;background:#f5f3ff;border:1.5px solid #e0e7ff;border-radius:999px;padding:6px 14px 6px 8px;font-size:13px;font-weight:700;color:#4f46e5;}
    .avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#4f46e5,#ec4899);display:flex;align-items:center;justify-content:center;color:white;font-size:13px;font-weight:800;}

    /* WRAP */
    .wrap{max-width:1200px;margin:0 auto;padding:24px 20px 60px;}

    /* HERO LOGIN */
    .hero{background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 50%,#ec4899 100%);border-radius:24px;padding:40px;color:white;display:flex;align-items:center;justify-content:space-between;gap:24px;flex-wrap:wrap;margin-bottom:0;overflow:hidden;position:relative;}
    .hero::before{content:'';position:absolute;top:-60px;right:-60px;width:220px;height:220px;background:rgba(255,255,255,0.08);border-radius:50%;}
    .hero::after{content:'';position:absolute;bottom:-40px;left:30%;width:160px;height:160px;background:rgba(255,255,255,0.06);border-radius:50%;}
    .hero-left h1{font-family:'Baloo 2',cursive;font-size:36px;font-weight:800;line-height:1.2;margin-bottom:8px;}
    .hero-left p{font-size:14px;opacity:0.85;max-width:42ch;line-height:1.6;margin-bottom:16px;}
    .features{display:flex;flex-wrap:wrap;gap:8px;}
    .feat{background:rgba(255,255,255,0.18);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.25);border-radius:999px;padding:5px 13px;font-size:12px;font-weight:700;}
    .login-box{background:white;border-radius:20px;padding:24px;min-width:270px;max-width:320px;box-shadow:0 8px 32px rgba(0,0,0,0.15);}
    .login-box h3{font-family:'Baloo 2',cursive;font-size:20px;color:var(--text);margin-bottom:4px;}
    .login-box p{font-size:12px;color:var(--muted);margin-bottom:16px;}
    .btn-google{width:100%;padding:13px;border:none;border-radius:14px;font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform .1s,box-shadow .1s;margin-bottom:10px;}
    .btn-google:active{transform:scale(.97)}
    .btn-student{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;box-shadow:0 4px 14px rgba(79,70,229,0.35);}
    .btn-student:hover{box-shadow:0 6px 20px rgba(79,70,229,0.45);}
    .btn-admin{background:linear-gradient(135deg,#f59e0b,#ef4444);color:white;box-shadow:0 4px 14px rgba(245,158,11,0.35);}
    .btn-admin:hover{box-shadow:0 6px 20px rgba(245,158,11,0.45);}
    button:disabled{opacity:0.6;cursor:not-allowed;}
    .login-msg{margin-top:10px;padding:10px 12px;border-radius:12px;font-size:12px;display:none;}
    .login-msg.info{background:#eff6ff;border:1px solid #bfdbfe;color:#1d4ed8;}
    .login-msg.error{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;}

    /* APP LAYOUT */
    .app-grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:24px;}
    @media(max-width:900px){.app-grid{grid-template-columns:1fr}}

    /* CARDS */
    .card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;}
    .card-title{font-family:'Baloo 2',cursive;font-size:20px;font-weight:700;margin-bottom:4px;}
    .card-sub{font-size:13px;color:var(--muted);}
    .divider{height:1px;background:#f1f5f9;margin:16px 0;}

    /* COURSE CARDS */
    .course-card{border-radius:14px;border:2px solid #e0e7ff;background:linear-gradient(135deg,#f5f3ff,#faf5ff);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:10px;transition:box-shadow .15s,transform .15s;flex-wrap:wrap;}
    .course-card:hover{box-shadow:0 4px 20px rgba(79,70,229,0.12);transform:translateY(-1px);}
    .course-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
    .course-info{flex:1;min-width:0;}
    .course-info b{font-size:15px;font-weight:800;display:block;}
    .btn-start{background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:12px;padding:10px 18px;font-family:'Nunito',sans-serif;font-weight:800;font-size:13px;cursor:pointer;box-shadow:0 3px 10px rgba(16,185,129,0.3);white-space:nowrap;}
    .lock-tag{background:#fef3c7;border:1.5px solid #fcd34d;color:#92400e;border-radius:999px;padding:6px 12px;font-size:11px;font-weight:800;white-space:nowrap;}

    /* TEST BOX */
    .timer-box{background:linear-gradient(135deg,#ef4444,#dc2626);color:white;border-radius:12px;padding:8px 16px;font-family:'Baloo 2',cursive;font-size:20px;font-weight:700;box-shadow:0 4px 12px rgba(239,68,68,0.3);}
    .qbox{background:#f8fafc;border:2px solid #e2e8f0;border-radius:14px;padding:16px;margin:10px 0;}
    .qbox b{font-size:15px;font-weight:800;display:block;margin-bottom:10px;}
    .opt{display:flex;align-items:center;gap:10px;padding:10px 14px;margin:7px 0;border-radius:12px;border:2px solid #e2e8f0;background:white;cursor:pointer;transition:all .12s;font-size:14px;font-weight:600;}
    .opt:hover{border-color:#a5b4fc;background:#f5f3ff;}
    .opt.selected{border-color:#4f46e5;background:#eef2ff;}

    /* ADMIN PANEL */
    .admin-card{background:white;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-bottom:16px;}
    .form-input{width:100%;padding:11px 14px;border-radius:12px;border:2px solid #e2e8f0;background:#f8fafc;font-family:'Nunito',sans-serif;font-size:14px;color:var(--text);outline:none;}
    .btn-save{background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:12px;padding:11px 20px;font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;cursor:pointer;margin-top:6px;}

    /* CHATBOT */
    .chat-fab{position:fixed;bottom:24px;right:24px;width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,#4f46e5,#7c3aed);border:none;color:white;font-size:24px;cursor:pointer;z-index:999;}
    .chat-box{position:fixed;bottom:90px;right:24px;width:300px;background:white;border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,0.15);z-index:998;display:none;flex-direction:column;overflow:hidden;max-height:400px;}
    .chat-box.open{display:flex;}
    .chat-head{background:linear-gradient(135deg,#4f46e5,#7c3aed);padding:14px 16px;color:white;display:flex;align-items:center;gap:10px;}
    .chat-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px;min-height:200px;}
    .chat-msg{max-width:85%;padding:8px 12px;border-radius:12px;font-size:13px;line-height:1.4;}
    .chat-msg.bot{background:#f0f4ff;align-self:flex-start;}
    .chat-msg.user{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;align-self:flex-end;}

    /* COMMON UTILS */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1a1f36;color:white;padding:12px 22px;border-radius:14px;display:none;z-index:9999;font-weight:700;}
    .fade-in{animation:fadeIn .3s ease forwards;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <a class="logo-wrap" href="#">
      <div class="logo-icon">ü¶â</div>
      <span class="logo-text">TestNest</span>
      <span class="logo-tag">BETA</span>
    </a>
    <div class="user-pill" id="topStatus">
      <div class="avatar" id="topAvatar">?</div>
      <span id="topName">Not logged in</span>
    </div>
  </div>
</div>

<div class="wrap">
  <div id="loginCard" class="hero fade-in">
    <div class="hero-left">
      <h1>üéØ Learn Smart,<br/>Score Big!</h1>
      <p>India's most fun test platform for students. Practice unlimited tests and track your progress!</p>
      <div class="features">
        <span class="feat">‚è±Ô∏è Timer Tests</span>
        <span class="feat">üèÜ Leaderboard</span>
        <span class="feat">‚úèÔ∏è Admin Panel</span>
      </div>
    </div>
    <div class="login-box">
      <h3>Welcome Back! üëã</h3>
      <p>Sign in with Google to continue</p>
      <button class="btn-google btn-student" id="btnStudent" onclick="loginAs('student')">Student Login (Google)</button>
      <button class="btn-google btn-admin" id="btnAdmin" onclick="loginAs('admin')">Admin Login (Google)</button>
      <div id="loginMsg" class="login-msg"></div>
    </div>
  </div>

  <div id="app" style="display:none;">
    <div class="app-grid">
      <div>
        <div class="card fade-in">
          <div class="card-title">üìö Courses</div>
          <div id="courseList">Loading...</div>
        </div>

        <div id="testBox" style="display:none;" class="card fade-in" style="margin-top:16px;">
          <div style="display:flex; justify-content:space-between;">
             <div class="card-title" id="testTitle">Test</div>
             <div class="timer-box" id="timerDisplay">00:00</div>
          </div>
          <div id="questionArea"></div>
          <button class="btn-save" onclick="submitTest()">‚úÖ Submit Test</button>
        </div>
      </div>

      <div>
        <div id="profileCard" class="card fade-in" style="background:linear-gradient(135deg,#4f46e5,#7c3aed); color:white;">
          <div class="avatar" id="profileAvatar" style="width:50px; height:50px; margin-bottom:10px;">üë§</div>
          <div id="userName" style="font-weight:bold;">‚Äî</div>
          <div id="userEmail" style="font-size:12px; opacity:0.8;">‚Äî</div>
          <div id="userRole" style="font-size:12px; margin-top:5px;">‚Äî</div>
          <button onclick="logout()" style="width:100%; margin-top:15px; padding:8px; border-radius:10px; border:none; cursor:pointer;">üö™ Logout</button>
        </div>

        <div class="admin-card" id="adminCard" style="display:none; margin-top:16px;">
          <div class="card-title">‚öôÔ∏è Admin Panel</div>
          <input type="text" class="form-input" id="courseName" placeholder="New Course Name" style="margin-bottom:10px;"/>
          <button class="btn-save" onclick="addCourse()">üíæ Save Course</button>
        </div>
      </div>
    </div>
  </div>
</div>

<button class="chat-fab" onclick="toggleChat()">ü¶â</button>
<div class="chat-box" id="chatBox">
  <div class="chat-head"><b>TestNest AI Tutor</b></div>
  <div class="chat-msgs" id="chatMsgs"></div>
  <div style="padding:10px; border-top:1px solid #eee; display:flex;">
    <input type="text" id="chatInput" placeholder="Ask me anything..." style="flex:1; padding:8px; border-radius:10px; border:1px solid #ddd;"/>
    <button onclick="sendChat()" style="margin-left:5px;">‚û§</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// INITIALIZE FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyAPML8zK9qgRQbUyv7lMVOtt0c5Osjyw_A",
  authDomain: "testnest-education.firebaseapp.com",
  projectId: "testnest-education",
  storageBucket: "testnest-education.firebasestorage.app",
  messagingSenderId: "1000142199756",
  appId: "1:1000142199756:web:afab8eaa0f6bc638969b69"
});

const auth = firebase.auth();
const db = firebase.firestore();
const ADMINS = ["dnyanrui90@gmail.com", "pawarjai999@gmail.com"];

function g(id){ return document.getElementById(id); }
function showMsg(m, t="info"){ g("loginMsg").textContent=m; g("loginMsg").className="login-msg "+t; g("loginMsg").style.display="block"; }
function hideMsg(){ g("loginMsg").style.display="none"; }
function setBtns(d){ g("btnStudent").disabled=d; g("btnAdmin").disabled=d; }
function initials(n){ return (n||"?").split(" ").map(w=>w[0]).join("").toUpperCase().slice(0,2); }

/* --- REFINED AUTH LOGIC --- */

function loginAs(role) {
  localStorage.setItem("tn_role", role);
  setBtns(true);
  showMsg("Redirecting to Google...", "info");

  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account" });

  // Use Redirect to bypass popup blockers on mobile
  auth.signInWithRedirect(provider);
}

// Handle Redirect Result
auth.getRedirectResult()
  .then((result) => {
    if (result && result.user) {
      hideMsg();
      setBtns(false);
    }
  })
  .catch((err) => {
    setBtns(false);
    if (err.code !== "auth/no-current-user") {
      showMsg("Login Error: " + err.message, "error");
    }
  });

// Auth State Observer
auth.onAuthStateChanged((user) => {
  if (user) {
    const savedRole = localStorage.getItem("tn_role");
    const isAdmin = ADMINS.includes(user.email?.toLowerCase());
    const finalRole = (savedRole === "admin" && isAdmin) ? "admin" : "student";
    
    g("loginCard").style.display = "none";
    g("app").style.display = "block";
    
    const name = user.displayName || "Learner";
    g("userName").textContent = name;
    g("userEmail").textContent = user.email || "";
    g("userRole").textContent = "Role: " + finalRole.toUpperCase();
    g("topName").textContent = name + " ‚Ä¢ " + finalRole.toUpperCase();
    g("topAvatar").textContent = initials(name);
    g("profileAvatar").textContent = initials(name);

    g("adminCard").style.display = finalRole === "admin" ? "block" : "none";

    // Load Data
    loadCourses();
  } else {
    g("loginCard").style.display = "flex";
    g("app").style.display = "none";
    g("topName").textContent = "Not logged in";
    g("topAvatar").textContent = "?";
  }
  setBtns(false);
});

function logout(){
  auth.signOut().then(() => {
    localStorage.removeItem("tn_role");
    location.reload(); // Hard reset for safety
  });
}

// APP FUNCTIONS
function loadCourses() {
  db.collection("courses").get().then(snap => {
    let html = "";
    snap.forEach(doc => {
      html += `<div class="course-card">
        <div class="course-icon">üìò</div>
        <div class="course-info"><b>${doc.id}</b></div>
        <button class="btn-start" onclick="startTest('${doc.id}')">Start</button>
      </div>`;
    });
    g("courseList").innerHTML = html || "No courses available.";
  });
}

function addCourse() {
  const name = g("courseName").value.trim();
  if(!name) return;
  db.collection("courses").doc(name).set({ createdAt: new Date() }).then(() => {
    g("courseName").value = "";
    loadCourses();
  });
}

function toggleChat(){ g('chatBox').classList.toggle('open'); }

function sendChat(){
  const inp = g('chatInput');
  const msgs = g('chatMsgs');
  if(!inp.value) return;
  msgs.innerHTML += `<div class="chat-msg user">${inp.value}</div>`;
  msgs.innerHTML += `<div class="chat-msg bot">I'm here to help! Keep studying! ü¶â</div>`;
  inp.value = "";
}

</script>
</body>
</html>
