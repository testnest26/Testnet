<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TESTNEST</title>
  <style>
    :root{--bg:#0b1020;--card:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.14);--text:#eaf0ff;--muted:rgba(234,240,255,0.70);--brand:#ff6b35;--brand2:#4b7bec;--ok:#2ecc71;--bad:#ff4757;--shadow:0 18px 60px rgba(0,0,0,0.35);--radius:18px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 700px at 20% 0%,rgba(75,123,236,0.28),transparent 55%),radial-gradient(900px 600px at 80% 10%,rgba(255,107,53,0.22),transparent 60%),linear-gradient(180deg,#070a14,var(--bg));color:var(--text);min-height:100vh;}
    .topbar{position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);background:rgba(10,14,30,0.65);border-bottom:1px solid rgba(255,255,255,0.08);}
    .topbar-inner{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:0.6px;}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 10px 30px rgba(255,107,53,0.25);}
    .brand span{font-size:18px}
    .pill{padding:8px 12px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.06);border-radius:999px;font-size:12px;color:var(--muted);max-width:60vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 40px;}
    .grid{display:grid;grid-template-columns:1.2fr 0.8fr;gap:16px;}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;}
    .muted{color:var(--muted);font-size:13px;line-height:1.45}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap}
    button{border:none;cursor:pointer;font-weight:800;border-radius:14px;padding:12px 14px;transition:transform .08s ease;}
    button:disabled{opacity:0.55;cursor:not-allowed;}
    button:not(:disabled):active{transform:scale(.98)}
    .btn{background:rgba(255,255,255,0.10);color:var(--text);border:1px solid rgba(255,255,255,0.14);}
    .btn-brand{background:linear-gradient(135deg,var(--brand),#ff915f);color:#120a07;}
    .btn-blue{background:linear-gradient(135deg,var(--brand2),#6ea6ff);color:#081022;}
    .btn-dark{background:rgba(0,0,0,0.25);color:var(--text);border:1px solid rgba(255,255,255,0.14);}
    .btn-ok{background:linear-gradient(135deg,var(--ok),#7bed9f);color:#04140b;}
    .btn-bad{background:linear-gradient(135deg,var(--bad),#ff6b81);color:#24060b;}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1;min-width:220px}
    input,select,textarea{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,0.16);background:rgba(0,0,0,0.20);color:var(--text);outline:none;}
    textarea{min-height:90px;resize:vertical}
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    .divider{height:1px;background:rgba(255,255,255,0.10);margin:14px 0}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:var(--muted);}
    .course{padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px;}
    .course b{font-size:15px}.lock{color:#ffd2c2}
    .timer{font-family:ui-monospace,monospace;font-weight:900;font-size:16px;color:#ffd2c2;}
    .qbox{border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);border-radius:16px;padding:12px;margin:10px 0;}
    .opt{display:block;padding:8px 10px;margin:7px 0;border-radius:12px;border:1px solid rgba(255,255,255,0.10);background:rgba(0,0,0,0.18)}
    .small{font-size:12px;color:var(--muted)}
    .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.82);color:var(--text);border:1px solid rgba(255,255,255,0.12);padding:10px 18px;border-radius:12px;display:none;z-index:999;max-width:92vw;font-size:14px;}
    .hero{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;}
    .hero h1{margin:0;font-size:28px}.hero .sub{color:var(--muted);max-width:60ch;line-height:1.5}
    .login-msg{margin-top:10px;padding:10px 12px;border-radius:12px;font-size:13px;display:none;}
    .login-msg.info{background:rgba(75,123,236,0.18);border:1px solid rgba(75,123,236,0.35);color:#a0c4ff;}
    .login-msg.error{background:rgba(255,71,87,0.18);border:1px solid rgba(255,71,87,0.35);color:#ffb3bb;}
  </style>
</head>
<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand"><div class="logo"></div><span>TESTNEST</span></div>
    <div class="pill" id="topStatus">Not logged in</div>
  </div>
</div>

<div class="wrap">
  <div class="card" id="loginCard">
    <div class="hero">
      <div>
        <h1>Learn â€¢ Practice â€¢ Test</h1>
        <div class="sub">Student login for tests + Leaderboard. Admin login to create courses, add unlimited questions, and lock paid courses.</div>
        <div style="margin-top:10px" class="row">
          <span class="tag">âœ… Timer Test</span><span class="tag">âœ… Auto Result</span>
          <span class="tag">âœ… Leaderboard</span><span class="tag">âœ… Paid Lock</span>
          <span class="tag">âœ… Admin Edit/Delete</span>
        </div>
      </div>
      <div style="min-width:260px;width:320px;max-width:100%;">
        <div class="card" style="box-shadow:none;background:rgba(255,255,255,0.06);">
          <h3 style="margin:0 0 8px 0;">Login</h3>
          <div class="muted">A Google popup will open. Please allow popups for this site if blocked.</div>
          <div class="btnrow" style="margin-top:12px;">
            <button class="btn-brand" id="btnStudent" onclick="loginAs('student')">Student Login (Google)</button>
            <button class="btn-blue" id="btnAdmin" onclick="loginAs('admin')">Admin Login (Google)</button>
          </div>
          <div id="loginMsg" class="login-msg"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="app" style="display:none;">
    <div class="grid">
      <div class="card">
        <div class="row" style="align-items:center">
          <div><h2 style="margin:0">Courses</h2><div class="muted">Start a free test. Paid courses show locked.</div></div>
          <div style="text-align:right"><button class="btn-dark" onclick="logout()">Logout</button></div>
        </div>
        <div class="divider"></div>
        <div id="courseList">Loading...</div>
        <div class="divider"></div>
        <div id="testBox" style="display:none;">
          <div class="row" style="align-items:center">
            <div><h3 id="testTitle" style="margin:0 0 4px 0;">Test</h3><div class="small" id="qCountInfo"></div></div>
            <div class="timer" id="timerDisplay">00:00</div>
          </div>
          <div id="questionArea"></div>
          <div class="btnrow">
            <button class="btn-ok" onclick="submitTest()">Submit Test</button>
            <button class="btn-bad" onclick="closeTest()">Close</button>
          </div>
        </div>
      </div>
      <div>
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Profile</h3>
          <div><b id="userName">â€”</b></div>
          <div class="small" id="userEmail">â€”</div>
          <div class="small" id="userRole">Role: â€”</div>
        </div>
        <div class="card" id="adminCard" style="display:none;margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">Admin Panel</h3>
          <div class="muted">Create courses, lock paid courses, add unlimited questions.</div>
          <div class="divider"></div>
          <label>Course Name</label>
          <input type="text" id="courseName" placeholder="e.g., Class 6 Maths / NEET / JEE"/>
          <label style="display:flex;align-items:center;gap:10px;margin-top:8px;">
            <input type="checkbox" id="paidCourse" style="width:18px;height:18px;accent-color:var(--brand);"> Paid Course (Locked)
          </label>
          <button class="btn-ok" onclick="addCourse()">Save Course</button>
          <div class="divider"></div>
          <label>Select course for adding questions</label>
          <select id="coursePick"><option value="">Select course</option></select>
          <label>Question</label>
          <textarea id="questionText" placeholder="Type your question..."></textarea>
          <div class="row">
            <div><label>Option A</label><input type="text" id="opt1" placeholder="Option A"/></div>
            <div><label>Option B</label><input type="text" id="opt2" placeholder="Option B"/></div>
          </div>
          <div class="row">
            <div><label>Option C</label><input type="text" id="opt3" placeholder="Option C"/></div>
            <div><label>Option D</label><input type="text" id="opt4" placeholder="Option D"/></div>
          </div>
          <div class="row">
            <div><label>Correct Option Index</label><input type="number" id="correct" placeholder="0=A, 1=B, 2=C, 3=D"/></div>
            <div><label>Test Time (minutes)</label><input type="number" id="timeLimit" placeholder="Example: 5"/></div>
          </div>
          <div class="btnrow">
            <button class="btn-brand" onclick="addQuestion()">Save Question</button>
            <button class="btn" onclick="clearQuestionForm()">Add Next Question</button>
          </div>
          <div class="small" style="margin-top:10px;">Tip: Select course and keep adding unlimited questions.</div>
        </div>
        <div class="card" style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">Leaderboard (Top 10)</h3>
          <div class="small">Top scores across all courses.</div>
          <div class="divider"></div>
          <div id="leaderboard">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyAPML8zK9qgRQbUyv7lMVOtt0c5Osjyw_A",
  authDomain: "testnest-education.firebaseapp.com",
  projectId: "testnest-education",
  storageBucket: "testnest-education.firebasestorage.app",
  messagingSenderId: "1000142199756",
  appId: "1:1000142199756:web:afab8eaa0f6bc638969b69"
});
const auth = firebase.auth();
const db   = firebase.firestore();
const ADMINS = ["dnyanrui90@gmail.com","pawarjai999@gmail.com"];

function g(id){ return document.getElementById(id); }
function toast(m){ const e=g("toast");e.textContent=m;e.style.display="block";setTimeout(()=>e.style.display="none",2800); }
function setTop(m){ g("topStatus").textContent=m; }
function showMsg(m,t="info"){ const e=g("loginMsg");e.textContent=m;e.className="login-msg "+t;e.style.display="block"; }
function hideMsg(){ g("loginMsg").style.display="none"; }
function setBtns(d){ g("btnStudent").disabled=d; g("btnAdmin").disabled=d; }
function esc(s){ return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escQ(s){ return (s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'"); }

// POPUP LOGIN â€” works on all devices without redirect session loss
function loginAs(role){
  localStorage.setItem("tn_role", role);
  setBtns(true);
  showMsg("Opening Google login windowâ€¦","info");

  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt:"select_account" });

  auth.signInWithPopup(provider)
    .then(result => {
      // Success â€” onAuthStateChanged will handle UI
      hideMsg();
    })
    .catch(err => {
      if(err.code === "auth/popup-blocked"){
        // Chrome blocked popup â€” tell user to allow it
        showMsg("âš ï¸ Popup blocked! Click the popup icon in your address bar and allow popups for this site, then try again.","error");
        setBtns(false);
      } else if(err.code === "auth/popup-closed-by-user"){
        showMsg("Login cancelled. Try again.","info");
        setBtns(false);
      } else {
        showMsg("Error: "+err.message,"error");
        setBtns(false);
      }
    });
}

function logout(){
  auth.signOut().then(()=>{
    localStorage.removeItem("tn_role");
    g("app").style.display="none";
    g("loginCard").style.display="block";
    setTop("Not logged in");
    setBtns(false);
    hideMsg();
  });
}

auth.onAuthStateChanged(user=>{
  if(!user){
    g("loginCard").style.display="block";
    g("app").style.display="none";
    return;
  }
  const role = (localStorage.getItem("tn_role")==="admin" && ADMINS.includes((user.email||"").toLowerCase())) ? "admin" : "student";
  g("loginCard").style.display="none";
  g("app").style.display="block";
  hideMsg(); setBtns(false);
  g("userName").textContent = user.displayName||"Student";
  g("userEmail").textContent = user.email||"";
  g("userRole").textContent = "Role: "+role.toUpperCase();
  setTop((user.displayName||"User")+" â€¢ "+role.toUpperCase());
  g("adminCard").style.display = role==="admin"?"block":"none";
  loadCourses(); loadLeaderboard();
  if(role==="admin") refreshCoursePick();
});

function loadCourses(){
  const div=g("courseList"); div.innerHTML="Loading...";
  db.collection("courses").get().then(snap=>{
    if(snap.empty){div.innerHTML='<div class="muted">No courses yet.</div>';return;}
    let html="";
    snap.forEach(doc=>{
      const name=doc.id,paid=!!doc.data().paid;
      html+=`<div class="course"><div><b>${esc(name)}</b><br/><span class="small">${paid?"Paid (Locked)":"Free (Test available)"}</span></div><div style="min-width:160px;text-align:right">${paid?'<span class="tag lock">ðŸ”’ Locked</span>':`<button class="btn-ok" onclick="startTest('${escQ(name)}')">Start Test</button>`}</div></div>`;
    });
    div.innerHTML=html;
  }).catch(e=>{div.innerHTML=`<div class="muted">${esc(e.message)}</div>`;});
}

function addCourse(){
  const name=g("courseName").value.trim(),paid=g("paidCourse").checked;
  if(!name)return alert("Enter course name");
  db.collection("courses").doc(name).set({paid,updatedAt:firebase.firestore.FieldValue.serverTimestamp(),createdBy:auth.currentUser.email||""},{merge:true})
    .then(()=>{toast("Course saved!");loadCourses();refreshCoursePick();}).catch(e=>alert(e.message));
}

function refreshCoursePick(){
  const sel=g("coursePick");if(!sel)return;
  sel.innerHTML='<option value="">Select course</option>';
  db.collection("courses").get().then(snap=>{snap.forEach(doc=>{const o=document.createElement("option");o.value=doc.id;o.textContent=doc.id;sel.appendChild(o);});}).catch(()=>{});
}

function clearQuestionForm(){["questionText","opt1","opt2","opt3","opt4","correct"].forEach(id=>g(id).value="");}

function addQuestion(){
  const course=(g("coursePick").value||"").trim();if(!course)return alert("Select a course first");
  const q=g("questionText").value.trim(),o1=g("opt1").value.trim(),o2=g("opt2").value.trim(),o3=g("opt3").value.trim(),o4=g("opt4").value.trim();
  const correct=parseInt(g("correct").value,10),time=parseInt(g("timeLimit").value,10);
  if(!q||!o1||!o2||!o3||!o4)return alert("Fill question + all options");
  if(isNaN(correct)||correct<0||correct>3)return alert("Correct must be 0-3");
  if(isNaN(time)||time<=0)return alert("Time must be > 0 minutes");
  db.collection("courses").doc(course).collection("questions").add({question:q,options:[o1,o2,o3,o4],correct,time,createdAt:firebase.firestore.FieldValue.serverTimestamp(),createdBy:auth.currentUser.email||""})
    .then(()=>{toast("Question saved!");clearQuestionForm();}).catch(e=>alert(e.message));
}

let currentCourse="",currentQuestions=[],timeLeft=0,timerInt=null;

function startTest(course){
  currentCourse=course;g("testTitle").textContent="Test: "+course;g("testBox").style.display="block";
  g("questionArea").innerHTML="Loading...";g("qCountInfo").textContent="";stopTimer();
  db.collection("courses").doc(course).collection("questions").get().then(snap=>{
    currentQuestions=[];snap.forEach(doc=>currentQuestions.push(doc.data()));
    if(!currentQuestions.length){g("questionArea").innerHTML='<div class="muted">No questions yet.</div>';return;}
    g("qCountInfo").textContent=currentQuestions.length+" questions";renderTest();startTimer((currentQuestions[0].time||5)*60);
  }).catch(e=>alert(e.message));
}

function renderTest(){
  const div=g("questionArea");div.innerHTML="";
  currentQuestions.forEach((q,i)=>{
    let opts="";(q.options||[]).forEach((o,idx)=>{opts+=`<label class="opt"><input type="radio" name="q${i}" value="${idx}" style="accent-color:var(--brand)"><span style="margin-left:8px">${esc(o)}</span></label>`;});
    div.innerHTML+=`<div class="qbox"><b>${i+1}. ${esc(q.question)}</b><div style="margin-top:8px">${opts}</div></div>`;
  });
}

function startTimer(s){stopTimer();timeLeft=s;updateTimer();timerInt=setInterval(()=>{timeLeft--;updateTimer();if(timeLeft<=0){stopTimer();submitTest();}},1000);}
function stopTimer(){if(timerInt){clearInterval(timerInt);timerInt=null;}}
function updateTimer(){const m=Math.floor(timeLeft/60),s=timeLeft%60;g("timerDisplay").textContent=(m<10?"0":"")+m+":"+(s<10?"0":"")+s;}
function closeTest(){stopTimer();g("testBox").style.display="none";}

function submitTest(){
  stopTimer();if(!currentQuestions.length){alert("No questions.");return;}
  let score=0;currentQuestions.forEach((q,i)=>{const sel=document.querySelector(`input[name="q${i}"]:checked`);if(sel&&parseInt(sel.value,10)===q.correct)score++;});
  const pct=Math.round((score/currentQuestions.length)*100);
  alert(`Score: ${score}/${currentQuestions.length} (${pct}%)`);
  const u=auth.currentUser;
  db.collection("leaderboard").add({user:u.displayName||u.email||"Student",email:u.email||"",score,total:currentQuestions.length,pct,course:currentCourse,at:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>loadLeaderboard());
  closeTest();
}

function loadLeaderboard(){
  const div=g("leaderboard");div.innerHTML="Loading...";
  db.collection("leaderboard").orderBy("pct","desc").orderBy("score","desc").limit(10).get().then(snap=>{
    if(snap.empty){div.innerHTML='<div class="muted">No scores yet.</div>';return;}
    let html="",i=1;
    snap.forEach(doc=>{const d=doc.data();html+=`<div style="margin:10px 0;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.05)"><b>${i++}. ${esc(d.user||"Student")}</b><div class="small">${esc(d.course||"")} â€¢ ${d.score}/${d.total} â€¢ ${d.pct}%</div></div>`;});
    div.innerHTML=html;
  }).catch(e=>{div.innerHTML=`<div class="muted">${esc(e.message)}</div>`;});
}
</script>
</body>
</html>
