<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAPML8zK9qgRQbUyv7lMVOtt0c5Osjyw_A",
  authDomain:"testnest-education.firebaseapp.com",
  projectId:"testnest-education",
  storageBucket:"testnest-education.firebasestorage.app",
  messagingSenderId:"1000142199756",
  appId:"1:1000142199756:web:afab8eaa0f6bc638969b69"
});

const auth=firebase.auth();
const db=firebase.firestore();
const ADMINS=["dnyanrui90@gmail.com","pawarjai999@gmail.com"];

function g(id){return document.getElementById(id);}
function esc(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function initials(n){return(n||"?").split(" ").map(w=>w[0]).join("").toUpperCase().slice(0,2);}

function loginAs(role){
  localStorage.setItem("tn_role",role);
  const p=new firebase.auth.GoogleAuthProvider();
  p.setCustomParameters({prompt:"select_account"});
  auth.signInWithPopup(p);
}

function logout(){
  auth.signOut();
  localStorage.removeItem("tn_role");
}

auth.onAuthStateChanged(user=>{
  if(!user){
    g("loginCard").style.display="flex";
    g("app").style.display="none";
    return;
  }

  const role=(localStorage.getItem("tn_role")==="admin"
      && ADMINS.includes((user.email||"").toLowerCase()))
      ? "admin" : "student";

  g("loginCard").style.display="none";
  g("app").style.display="block";

  g("userName").textContent=user.displayName||"Student";
  g("userEmail").textContent=user.email||"";
  g("userRole").textContent="Role: "+role.toUpperCase();
  g("topName").textContent=(user.displayName||"Student")+" â€¢ "+role.toUpperCase();
  g("topAvatar").textContent=initials(user.displayName||"Student");
  g("profileAvatar").textContent=initials(user.displayName||"Student");

  g("adminCard").style.display=role==="admin"?"block":"none";
  g("manageBox").style.display=role==="admin"?"block":"none";

  loadCourses();
  loadLeaderboardCourses();
});


// ================= COURSES =================

function loadCourses(){
  const div=g("courseList");
  div.innerHTML="Loading...";
  db.collection("courses").get().then(snap=>{
    if(snap.empty){div.innerHTML="No courses yet.";return;}
    let html="";
    snap.forEach(doc=>{
      const name=doc.id;
      const paid=doc.data().paid;
      html+=`
        <div class="course-card">
          <div class="course-info">
            <b>${esc(name)}</b>
            <span>${paid?"ðŸ”’ Premium":"âœ… Free"}</span>
          </div>
          ${paid?
            `<span class="lock-tag">Locked</span>`:
            `<button class="btn-start" onclick="startTest('${name}')">Start</button>`
          }
        </div>`;
    });
    div.innerHTML=html;
  });
}


// ================= LEADERBOARD FIX =================

function loadLeaderboardCourses(){
  const sel=g("lbCourseSel");
  sel.innerHTML='<option value="">â€” Select Course â€”</option>';

  db.collection("courses").get().then(snap=>{
    snap.forEach(doc=>{
      const o=document.createElement("option");
      o.value=doc.id;
      o.textContent=doc.id;
      sel.appendChild(o);
    });
  });
}

function loadLeaderboard(){
  const div=g("leaderboard");
  const course=g("lbCourseSel").value;

  if(!course){
    div.innerHTML="Select course.";
    return;
  }

  div.innerHTML="Loading...";

  db.collection("leaderboard")
    .where("course","==",course)
    .orderBy("pct","desc")
    .limit(10)
    .get()
    .then(snap=>{
      if(snap.empty){
        div.innerHTML="No scores yet.";
        return;
      }

      let html="";
      let i=1;

      snap.forEach(doc=>{
        const d=doc.data();
        html+=`
          <div class="lb-row">
            <div class="lb-rank">${i}</div>
            <div class="lb-name">${esc(d.user)}</div>
            <div class="lb-score">${d.score}/${d.total} (${d.pct}%)</div>
          </div>`;
        i++;
      });

      div.innerHTML=html;
    });
}

</script>
